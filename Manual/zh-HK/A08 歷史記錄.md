# A08 歷史記錄

跟一般應用軟件的的歷史版本記錄不同，Yu Writer 會記錄一個文檔編輯的全過程，包括每次錄入的字符、每次刪除的字符。所以 Yu Writer 能做到真正的回滾到歷史上的任一時刻，無論是程序意外退出，還是用户手誤操作，理論上都不會丟失勞動成果。

## 進入歷史記錄視圖

在編輯文檔時，點擊工具欄的 `歷史記錄`，此時整個應用程序窗口（除了工具欄）會被用來顯示文檔的歷史記錄信息。

### 查看歷史記錄的每個節點

歷史記錄視圖下側顯示的是文檔的完整編輯歷史記錄，其中每一根柱子表示一個版本，文檔的版本是 Yu Writer 在每次編輯時（完成 “打開——編輯——關閉” 這 3 個過程即為一次編輯）自動創建的，一個版本就是一系列的變化信息的集合。版本的作用類似時間軸，通過版本可以很快找到編輯歷史上的某個時刻。

版本柱裏面深色區域表示變化的信息，區域越飽滿表示該版本發生的變化信息越多。可以用鼠標點擊深色區域或者按鍵盤的上下箭頭鍵查看每一個變化信息的具體內容。歷史記錄視圖上方顯示的是每次變化時的文檔內容，其中紅色表示刪除的文字，綠色表示增加的文字。

### 重播歷史

先選取某個時間點，然後點擊視圖下側的 `重播` 按鈕，則會重新演繹一次文檔的編輯過程。

### 回滾歷史

選擇任意時間點，然後點擊視圖下側的 `回滾` 按鈕，則文檔內容會恢復到選中的時間點。在回滾時，如果文檔已經發生過改變，則在回滾的之前會自動創建一個版本，用於避免錯誤回滾。

## 恢復文檔到初始狀態

如果打開了一個文檔並進行了一些修改，如果此時想放棄當次修改，讓文檔恢復到打開時的初始狀態，可以點擊菜單 `文件` -> `恢復內容到初始狀態`，文檔在恢復到初始狀態的同時，剛才所作的修改也會保存到歷史記錄了，用於避免錯誤恢復。

## 手動創建文檔快照

你可以在任意時候手動創建一個版本（即快照），點擊菜單 `文件` -> `保存快照` 會彈出一個創建快照的窗口，在窗口裏填入一些用於描述該版本的文本信息，再點擊 `創建` 按鈕即完成。

## 工作原理

當文檔內容發生改變時，Yu Writer 對比改變前的內容而得到改變信息，改變信息包括：是增加了字符、還是刪除了字符，改變的字符是什麼，字符的位置在哪裏等。然後把這些改變信息組成一條序列並記錄在內存裏。然後每經過設定的時間（默認是 60 秒）就把這條序列保存到文檔的歷史記錄文件裏，再清空內存中的這條序列，然後再記錄接下來的改變，周而復始。

雖然 Yu Writer 的歷史記錄保存的是文檔的編輯全過程，但也不用擔心歷史文件會很大，因為它每次保存的數據量其實很小。

因為有時歷史記錄可以幫助我們挽回重要的工作數據，所以 Yu Writer 還會做一些額外的優化：

* 連續錄入或者連續刪除會合併為一個變化。比如連續錄入 “a”、“b” 和 “c” 3 個字符，Yu Writer 會把它們合併為 1 次錄入 “abc”，這樣能減少歷史記錄條目的數量但又不丟失關鍵信息。
* 當改變信息達到一定的數量時，Yu Writer 會儲存一次完整的文檔內容，這個儲存點稱為 “關鍵幀”，“關鍵幀” 能夠保證恢復歷史記錄時更準確，即可以防止因為程序出錯導致某個歷史變化信息錯誤從而導致恢復失敗。（目前創建關鍵幀的時機跟創建版本是一樣的，但將來可能會更改為根據變化信息的數量而執行。）

## 歷史數據文件

默認配置下歷史信息文件儲存在跟文檔同一個目錄的一個名為 `xxx.resource` 的文件夾之內，文件名為 `commit.json`，其中的 “xxx” 為文檔的文件名。你可以修改文檔庫的配置文件，讓這個數據文件存放在其他地方，詳細請參閲 [C02 配置文檔庫](c02-配置文檔庫)。

### 排除歷史數據文件

如果你的文檔位於 Git 倉庫之內，並且不希望提交歷史記錄文件，可以修改 Git 倉庫的 `.gitignore` 添加如下一行用於排除歷史數據文件：

```config
*.resource/
```

## 歷史的衝突

如果同時在多個 Yu Writer 窗口裏編輯同一個文檔，Yu Writer 能正確合併每個窗口所產生的變化而不會導致內容相互覆蓋或者歷史衝突。

如果在 Yu Writer 正在編輯文檔的同時，又使用其他應用程序打開同一個文檔，並且修改了文檔內容並保存，這時 Yu Writer 會感知文檔內容在外部發生改變（注：外部修改感知功能尚未完成）並顯示提示信息詢問用户是否重新加載文檔。如果不重新加載，則外部改變的內容會被保存為一個歷史版本，如果重新加載則當前編輯的改變會保存為一個歷史版本。簡單來説 Yu Writer 會把衝突的內容都保存在歷史記錄裏，然後由用户自己來選擇採用哪個版本。

