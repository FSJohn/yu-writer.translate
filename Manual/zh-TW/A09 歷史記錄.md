# A09 歷史記錄

跟一般應用軟體的的歷史版本記錄不同，Yu Writer 會記錄一個文件編輯的全過程，包括每次錄入的字元、每次刪除的字元。所以 Yu Writer 能做到真正的回滾到歷史上的任一時刻，無論是程式意外退出，還是使用者手誤操作，理論上都不會丟失勞動成果。

## 進入歷史記錄檢視

在編輯文件時，點選工具欄的 `歷史記錄`，此時整個應用程式視窗（除了工具欄）會被用來顯示文件的歷史記錄資訊。

### 檢視歷史記錄的每個節點

歷史記錄檢視下側顯示的是文件的完整編輯歷史記錄，其中每一根柱子表示一個版本，文件的版本是 Yu Writer 在每次編輯時（完成 “開啟——編輯——關閉” 這 3 個過程即為一次編輯）自動建立的，一個版本就是一系列的變化資訊的集合。版本的作用類似時間軸，通過版本可以很快找到編輯歷史上的某個時刻。

版本柱裡面深色區域表示變化的資訊，區域越飽滿表示該版本發生的變化資訊越多。可以用滑鼠點選深色區域或者按鍵盤的上下箭頭鍵檢視每一個變化資訊的具體內容。歷史記錄檢視上方顯示的是每次變化時的文件內容，其中紅色表示刪除的文字，綠色表示增加的文字。

### 重播歷史

先選取某個時間點，然後點選檢視下側的 `重播` 按鈕，則會重新演繹一次文件的編輯過程。

### 回滾歷史

選擇任意時間點，然後點選檢視下側的 `回滾` 按鈕，則文件內容會恢復到選中的時間點。在回滾時，如果文件已經發生過改變，則在回滾的之前會自動建立一個版本，用於避免錯誤回滾。

## 恢復文件到初始狀態

如果打開了一個文件並進行了一些修改，如果此時想放棄當次修改，讓文件恢復到開啟時的初始狀態，可以點選選單 `檔案` -> `恢復內容到初始狀態`，文件在恢復到初始狀態的同時，剛才所作的修改也會儲存到歷史記錄了，用於避免錯誤恢復。

## 手動建立文件快照

你可以在任意時候手動建立一個版本（即快照），點選選單 `檔案` -> `儲存快照` 會彈出一個建立快照的視窗，在窗口裡填入一些用於描述該版本的文字資訊，再點選 `建立` 按鈕即完成。

## 工作原理

當文件內容發生改變時，Yu Writer 對比改變前的內容而得到改變資訊，改變資訊包括：是增加了字元、還是刪除了字元，改變的字元是什麼，字元的位置在哪裡等。然後把這些改變資訊組成一條序列並記錄在記憶體裡。然後每經過設定的時間（預設是 60 秒）就把這條序列儲存到文件的歷史記錄檔案裡，再清空記憶體中的這條序列，然後再記錄接下來的改變，周而復始。

雖然 Yu Writer 的歷史記錄儲存的是文件的編輯全過程，但也不用擔心歷史檔案會很大，因為它每次儲存的資料量其實很小。

因為有時歷史記錄可以幫助我們挽回重要的工作資料，所以 Yu Writer 還會做一些額外的優化：

* 連續錄入或者連續刪除會合併為一個變化。比如連續錄入 “a”、“b” 和 “c” 3 個字元，Yu Writer 會把它們合併為 1 次錄入 “abc”，這樣能減少歷史記錄條目的數量但又不丟失關鍵資訊。
* 當改變資訊達到一定的數量時，Yu Writer 會儲存一次完整的文件內容，這個儲存點稱為 “關鍵幀”，“關鍵幀” 能夠保證恢復歷史記錄時更準確，即可以防止因為程式出錯導致某個歷史變化資訊錯誤從而導致恢復失敗。（目前建立關鍵幀的時機跟建立版本是一樣的，但將來可能會更改為根據變化資訊的數量而執行。）

## 歷史資料檔案

預設配置下歷史資訊檔案儲存在跟文件同一個目錄的一個名為 `xxx.resource` 的資料夾之內，檔名為 `commit.json`，其中的 “xxx” 為文件的檔名。你可以修改文件庫的配置檔案，讓這個資料檔案存放在其他地方，詳細請參閱 [C02 配置文件庫](c02-配置文件庫)。

### 排除歷史資料檔案

如果你的文件位於 Git 倉庫之內，並且不希望提交歷史記錄檔案，可以修改 Git 倉庫的 `.gitignore` 新增如下一行用於排除歷史資料檔案：

```config
*.resource/
```

## 歷史的衝突

如果同時在多個 Yu Writer 窗口裡編輯同一個文件，Yu Writer 能正確合併每個視窗所產生的變化而不會導致內容相互覆蓋或者歷史衝突。

如果在 Yu Writer 正在編輯文件的同時，又使用其他應用程式開啟同一個文件，並且修改了文件內容並儲存，這時 Yu Writer 會感知文件內容在外部發生改變（注：外部修改感知功能尚未完成）並顯示提示資訊詢問使用者是否重新載入文件。如果不重新載入，則外部改變的內容會被儲存為一個歷史版本，如果重新載入則當前編輯的改變會儲存為一個歷史版本。簡單來說 Yu Writer 會把衝突的內容都儲存在歷史記錄裡，然後由使用者自己來選擇採用哪個版本。

